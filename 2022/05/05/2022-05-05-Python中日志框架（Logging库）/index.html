<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">



  
  
  <link rel="stylesheet" href="/lib/Han/dist/han.min.css?v=3.3">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="[TOC] 背景https://murphypei.github.io/blog/2019/09/python-logging Python版本为Python 3.8.8 第一部分 内置Logging包1.1 日志级别   等级  数值     CRITICAL 严重；导致应用无法运行的重大错误； 50   ERROR 错误 40   WARNING 警告 30   INFO 信息 20   DE">
<meta property="og:type" content="article">
<meta property="og:title" content="Python中日志框架（Logging库）">
<meta property="og:url" content="https://zjrongxiang.github.io/2022/05/05/2022-05-05-Python中日志框架（Logging库）/index.html">
<meta property="og:site_name" content="RongXiang">
<meta property="og:description" content="[TOC] 背景https://murphypei.github.io/blog/2019/09/python-logging Python版本为Python 3.8.8 第一部分 内置Logging包1.1 日志级别   等级  数值     CRITICAL 严重；导致应用无法运行的重大错误； 50   ERROR 错误 40   WARNING 警告 30   INFO 信息 20   DE">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="d:/myblog/source/_posts/images/picture/PythonLogging/logging_flow.png">
<meta property="og:updated_time" content="2022-06-15T05:32:53.179Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python中日志框架（Logging库）">
<meta name="twitter:description" content="[TOC] 背景https://murphypei.github.io/blog/2019/09/python-logging Python版本为Python 3.8.8 第一部分 内置Logging包1.1 日志级别   等级  数值     CRITICAL 严重；导致应用无法运行的重大错误； 50   ERROR 错误 40   WARNING 警告 30   INFO 信息 20   DE">
<meta name="twitter:image" content="d:/myblog/source/_posts/images/picture/PythonLogging/logging_flow.png">



  <link rel="alternate" href="/atom.xml" title="RongXiang" type="application/atom+xml">




  <link rel="canonical" href="https://zjrongxiang.github.io/2022/05/05/2022-05-05-Python中日志框架（Logging库）/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Python中日志框架（Logging库） | RongXiang</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-113063423-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-113063423-1');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <!-- <a href="https://github.com/zjrongxiang"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a> -->
    <a href="https://github.com/zjrongxiang"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">RongXiang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">我的烂笔头</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
    
      
    

    

    <a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>日程表</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zjrongxiang.github.io/2022/05/05/2022-05-05-Python中日志框架（Logging库）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="rong xiang">
      <meta itemprop="description" content="Keep a Pure Curiosity">
      <meta itemprop="image" content="/images/avatar/person.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RongXiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Python中日志框架（Logging库）

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-05-05 13:30:00" itemprop="dateCreated datePublished" datetime="2022-05-05T13:30:00+08:00">2022-05-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-06-15 13:32:53" itemprop="dateModified" datetime="2022-06-15T13:32:53+08:00">2022-06-15</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/05/05/2022-05-05-Python中日志框架（Logging库）/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/05/05/2022-05-05-Python中日志框架（Logging库）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">63k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">57 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>[TOC]</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p><a href="https://murphypei.github.io/blog/2019/09/python-logging" target="_blank" rel="noopener">https://murphypei.github.io/blog/2019/09/python-logging</a></p>
<p>Python版本为Python 3.8.8</p>
<h2 id="第一部分-内置Logging包"><a href="#第一部分-内置Logging包" class="headerlink" title="第一部分 内置Logging包"></a>第一部分 内置<code>Logging</code>包</h2><h3 id="1-1-日志级别"><a href="#1-1-日志级别" class="headerlink" title="1.1 日志级别"></a>1.1 日志级别</h3><table>
<thead>
<tr>
<th style="text-align:left">等级</th>
<th></th>
<th style="text-align:left">数值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>CRITICAL</code></td>
<td>严重；导致应用无法运行的重大错误；</td>
<td style="text-align:left">50</td>
</tr>
<tr>
<td style="text-align:left"><code>ERROR</code></td>
<td>错误</td>
<td style="text-align:left">40</td>
</tr>
<tr>
<td style="text-align:left"><code>WARNING</code></td>
<td>警告</td>
<td style="text-align:left">30</td>
</tr>
<tr>
<td style="text-align:left"><code>INFO</code></td>
<td>信息</td>
<td style="text-align:left">20</td>
</tr>
<tr>
<td style="text-align:left"><code>DEBUG</code></td>
<td>调试</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left"><code>NOTSET</code></td>
<td>通知</td>
<td style="text-align:left">0</td>
</tr>
</tbody>
</table>
<p>当然<code>logging</code>包也提供用户自定义日志级别。日志级别通过数值量化比较。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增格式：</span></span><br><span class="line"><span class="comment"># logging.addLevelName(level, levelName)</span></span><br><span class="line">logging.addLevelName(<span class="number">25</span>, <span class="string">'POINT'</span>)</span><br></pre></td></tr></table></figure>
<p>代码中定义了新的日志级别：<code>POINT</code>，级别值25，在<code>DEBUG</code>和<code>INFO</code>之间。</p>
<h3 id="1-2-日志流"><a href="#1-2-日志流" class="headerlink" title="1.2 日志流"></a>1.2 日志流</h3><p>参考官网文档：<a href="https://docs.python.org/3/howto/logging.html#logging-basic-tutorial" target="_blank" rel="noopener">https://docs.python.org/3/howto/logging.html#logging-basic-tutorial</a></p>
<p>详细流程如下图，其中涉及角色有：</p>
<ul>
<li><code>Logger</code>：日志对象。定义后供业务程序调用。判断可用性开关参数，日志级别。不满足条件结束。</li>
<li><code>LogRecord</code> ：日志记录器。多于满足过滤器条件，流程结束。否则继续给将日志传到相应的处理器（Handler）处理。</li>
<li><code>Handler</code> ：处理器。将日志记录器产生的日志记录发送至合适的目的地。提供各类处理器配置。</li>
<li><code>Filter</code> ：过滤器。提供了更好的粒度控制,可以决定输出哪些日志记录。</li>
<li><code>Formatter</code>：格式化器。指明了最终输出中日志记录的格式。</li>
</ul>
<p><img src="D:\myblog\source\_posts\images\picture\PythonLogging\logging_flow.png" alt="logging_flow"></p>
<p>官网中将日志<code>Flow</code>分为<code>Logger Flow</code>和<code>Handler Flow</code>，具体处理如下：</p>
<ul>
<li>判断 <code>Logger</code> 对象对于设置的级别是否可用，如果可用，则往下执行，否则，流程结束。</li>
<li>创建 <code>LogRecord</code> 对象，如果注册到 <code>Logger</code>对象中的 <code>Filter</code> 对象过滤后返回 <code>False</code>，则不记录日志，流程结束，否则，则向下执行。</li>
<li><code>LogRecord</code> 对象将 <code>Handler</code> 对象传入当前的 <code>Logger</code> 对象，（图中的子流程）如果 <code>Handler</code> 对象的日志级别大于设置的日志级别，再判断注册到 Handler 对象中的 Filter 对象过滤后是否返回 <code>True</code> 而放行输出日志信息，否则不放行，流程结束。</li>
<li>如果传入的 <code>Handler</code> 大于 <code>Logger</code> 中设置的级别，也即 <code>Handler</code> 有效，则往下执行，否则，流程结束。</li>
<li>判断这个 <code>Logger</code> 对象是否还有父 <code>Logger</code> 对象，如果没有（代表当前 <code>Logger</code> 对象是最顶层的 <code>Logger</code> 对象 <code>root Logger</code>），流程结束。否则将 <code>Logger</code> 对象设置为它的父 <code>Logger</code> 对象，重复上面的 3、4 两步，输出父类 <code>Logger</code> 对象中的日志输出，直到是 <code>root Logger</code> 为止。</li>
</ul>
<p>上述流程我们后面会结合具体配置文件详细说明。</p>
<h3 id="1-3-基本使用"><a href="#1-3-基本使用" class="headerlink" title="1.3 基本使用"></a>1.3 基本使用</h3><h4 id="1-3-1-例子"><a href="#1-3-1-例子" class="headerlink" title="1.3.1 例子"></a>1.3.1 例子</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(filename=<span class="string">"test.log"</span>,</span><br><span class="line">                    filemode=<span class="string">"a"</span>,</span><br><span class="line">                    format=<span class="string">"%(asctime)s %(name)s:%(levelname)s:%(message)s"</span>,</span><br><span class="line">                    datefmt=<span class="string">"%d-%M-%Y %H:%M:%S"</span>,</span><br><span class="line">                    level=logging.INFO)</span><br><span class="line"></span><br><span class="line">logging.debug(<span class="string">'debug'</span>)</span><br><span class="line">logging.info(<span class="string">'info'</span>)</span><br><span class="line">logging.warning(<span class="string">'warning'</span>)</span><br><span class="line">logging.error(<span class="string">'error'</span>)</span><br><span class="line">logging.critical(<span class="string">'critical'</span>)</span><br><span class="line"><span class="comment"># 输出test.log（文件若不存在，自动创建），追加写入。</span></span><br><span class="line"><span class="comment">#05-38-2022 20:38:32 root:INFO:info</span></span><br><span class="line"><span class="comment">#05-38-2022 20:38:32 root:WARNING:warning</span></span><br><span class="line"><span class="comment">#05-38-2022 20:38:32 root:ERROR:error</span></span><br><span class="line"><span class="comment">#05-38-2022 20:38:32 root:CRITICAL:critical</span></span><br></pre></td></tr></table></figure>
<p><code>basicConfig</code> 定义了日志的各类配置参数，具体如下：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th style="text-align:left">参数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>filename</code></td>
<td style="text-align:left">日志输出到文件的文件名</td>
</tr>
<tr>
<td><code>filemode</code></td>
<td style="text-align:left">文件模式，r[+]、w[+]、a[+]</td>
</tr>
<tr>
<td><code>format</code></td>
<td style="text-align:left">日志输出的格式</td>
</tr>
<tr>
<td><code>datefmt</code></td>
<td style="text-align:left">日志附带日期时间的格式</td>
</tr>
<tr>
<td><code>style</code></td>
<td style="text-align:left">格式占位符，默认为 “%” 和 “{}”</td>
</tr>
<tr>
<td><code>level</code></td>
<td style="text-align:left">设置日志输出级别</td>
</tr>
<tr>
<td><code>stream</code></td>
<td style="text-align:left">定义输出流，用来初始化 <code>StreamHandler</code> 对象，不能 <code>filename</code> 参数一起使用，否则会<code>ValueError</code> 异常</td>
</tr>
<tr>
<td><code>handles</code></td>
<td style="text-align:left">定义处理器，用来创建 <code>Handler</code> 对象，不能和 <code>filename</code> 、<code>stream</code> 参数一起使用，否则也会抛出 <code>ValueError</code> 异常</td>
</tr>
</tbody>
</table>
<h4 id="1-3-2-日志记录"><a href="#1-3-2-日志记录" class="headerlink" title="1.3.2 日志记录"></a>1.3.2 日志记录</h4><p>每条日志都是一个<code>LogRecord</code> 对象，<code>record</code>对象对象的全部属性如下表。例子中，通过<code>format</code>参数定义日志输出格式，例如：<code>format=&quot;%(asctime)s %(name)s:%(levelname)s:%(message)s&quot;</code>。其中<code>message</code>参数是用户提供，其他参数有用户自定义选取和组织。</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>格式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>args</td>
<td>You shouldn’t need to format this yourself.</td>
<td>The tuple of arguments merged into <code>msg</code> to produce <code>message</code>, or a dict whose values are used for the merge (when there is only one argument, and it is a dictionary).</td>
</tr>
<tr>
<td>asctime</td>
<td><code>%(asctime)s</code></td>
<td>将日志的时间构造成可读的形式，默认情况下是精确到毫秒，如 <code>2018-10-13 23:24:57,832</code>，可以额外指定 <code>datefmt</code> 参数来指定该变量的格式</td>
</tr>
<tr>
<td>created</td>
<td><code>%(created)f</code></td>
<td>Time when the <a href="https://docs.python.org/3.4/library/logging.html#logging.LogRecord" target="_blank" rel="noopener"><code>LogRecord</code></a> was created (as returned by <a href="https://docs.python.org/3.4/library/time.html#time.time" target="_blank" rel="noopener"><code>time.time()</code></a>).</td>
</tr>
<tr>
<td>exc_info</td>
<td>You shouldn’t need to format this yourself.</td>
<td>Exception tuple (à la <code>sys.exc_info</code>) or, if no exception has occurred, <em>None</em>.</td>
</tr>
<tr>
<td>filename</td>
<td><code>%(filename)s</code></td>
<td>不包含路径的文件名</td>
</tr>
<tr>
<td>funcName</td>
<td><code>%(funcName)s</code></td>
<td>日志记录所在的函数名</td>
</tr>
<tr>
<td>levelname</td>
<td><code>%(levelname)s</code></td>
<td>日志的级别名称 (<code>&#39;DEBUG&#39;</code>, <code>&#39;INFO&#39;</code>, <code>&#39;WARNING&#39;</code>, <code>&#39;ERROR&#39;</code>,<code>&#39;CRITICAL&#39;</code>).</td>
</tr>
<tr>
<td>levelno</td>
<td><code>%(levelno)s</code></td>
<td>Numeric logging level for the message (<code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code>,<code>CRITICAL</code>).</td>
</tr>
<tr>
<td>lineno</td>
<td><code>%(lineno)d</code></td>
<td>日志记录所在的行号</td>
</tr>
<tr>
<td>module</td>
<td><code>%(module)s</code></td>
<td>Module (name portion of <code>filename</code>).</td>
</tr>
<tr>
<td>msecs</td>
<td><code>%(msecs)d</code></td>
<td>Millisecond portion of the time when the <a href="https://docs.python.org/3.4/library/logging.html#logging.LogRecord" target="_blank" rel="noopener"><code>LogRecord</code></a> was created.</td>
</tr>
<tr>
<td>message</td>
<td><code>%(message)s</code></td>
<td>具体的日志信息, computed as <code>msg % args</code>. This is set when<a href="https://docs.python.org/3.4/library/logging.html#logging.Formatter.format" target="_blank" rel="noopener"><code>Formatter.format()</code></a> is invoked.</td>
</tr>
<tr>
<td>msg</td>
<td>You shouldn’t need to format this yourself.</td>
<td>The format string passed in the original logging call. Merged with <code>args</code> to produce <code>message</code>, or an arbitrary object (see <a href="https://docs.python.org/3.4/howto/logging.html#arbitrary-object-messages" target="_blank" rel="noopener">Using arbitrary objects as messages</a>).</td>
</tr>
<tr>
<td>name</td>
<td><code>%(name)s</code></td>
<td>日志对象的名称</td>
</tr>
<tr>
<td>pathname</td>
<td><code>%(pathname)s</code></td>
<td>进行日志调用的源文件的完整路径名</td>
</tr>
<tr>
<td>process</td>
<td><code>%(process)d</code></td>
<td>当前进程ID</td>
</tr>
<tr>
<td>processName</td>
<td><code>%(processName)s</code></td>
<td>当前进程名称</td>
</tr>
<tr>
<td>relativeCreated</td>
<td><code>%(relativeCreated)d</code></td>
<td>Time in milliseconds when the LogRecord was created, relative to the time the logging module was loaded.</td>
</tr>
<tr>
<td>stack_info</td>
<td>You shouldn’t need to format this yourself.</td>
<td>Stack frame information (where available) from the bottom of the stack in the current thread, up to and including the stack frame of the logging call which resulted in the creation of this record.</td>
</tr>
<tr>
<td>thread</td>
<td><code>%(thread)d</code></td>
<td>当前线程ID</td>
</tr>
<tr>
<td>threadName</td>
<td><code>%(threadName)s</code></td>
<td>当前线程名称</td>
</tr>
</tbody>
</table>
<p>如果对于系统自带的参数集合不满足需求。<code>logging</code>包从<code>Python 3.2</code>起提供了<code>Factory</code>函数<code>getLogRecordFactory()</code> 和<code>setLogRecordFactory()</code>支持用户自定义record属性。例如对于分布式部署的环境，日志需要有程序部署节点和主机名和<code>ip</code>信息，需要用户自己新增定义。例如下面的案例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">historyFactory = logging.getLogRecordFactory()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">record_factory</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    record = historyFactory(*args, **kwargs)</span><br><span class="line">    record.hostname = socket.gethostname()</span><br><span class="line">    record.hostip = socket.gethostbyname(socket.gethostname())</span><br><span class="line">    <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">logging.setLogRecordFactory(record_factory)</span><br></pre></td></tr></table></figure>
<p>这样就可以配置<code>format</code>的时候就可以引用已经定义的参数<code>hostname</code>和<code>hostip</code>。上面的函数相当于在<code>record</code>中新增两个参数的定义。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">format:</span> <span class="string">"%(asctime)s - %(hostname)s - %(hostip)s - %(levelname)s - %(name)s(%(lineno)d) - %(message)s"</span></span><br><span class="line"><span class="comment"># 输出：2022-05-08 15:24:54,163 - localhost-PC - 192.168.152.1 - INFO - TestLogger(48) - info</span></span><br></pre></td></tr></table></figure>
<p>另外还可以继承<code>logging.Formatter</code>，例如（代码片段放在<code>__ini__.py</code>中，<code>Python</code>的模块名为：<code>logTest</code>）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomFormatter</span><span class="params">(logging.Formatter)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">format</span><span class="params">(self, record)</span>:</span></span><br><span class="line">        record.hostname = socket.gethostname()</span><br><span class="line">        record.hostip = socket.gethostbyname(socket.gethostname())</span><br><span class="line">        <span class="keyword">return</span> super().format(record)</span><br></pre></td></tr></table></figure>
<p>使用<code>yaml</code>配置文件时，配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">formatters:</span></span><br><span class="line"><span class="attr">  custom:</span></span><br><span class="line"><span class="attr">    format:</span> <span class="string">"%(asctime)s - %(hostname)s - %(hostip)s - %(levelname)s - %(name)s(%(lineno)d) - %(message)s"</span></span><br><span class="line">    <span class="string">():</span> <span class="string">logTest.CustomFormatter</span></span><br></pre></td></tr></table></figure>
<p>另外也可以通过自定义日志过滤器 <code>filter</code> 方法来实现。<code>filter</code>实际上既可以过滤日志，也可以添加字段参数和改写<code>record</code>，具有灵活的表达能力。我们在后文介绍。</p>
<h4 id="1-3-3-日志切割"><a href="#1-3-3-日志切割" class="headerlink" title="1.3.3 日志切割"></a>1.3.3 日志切割</h4><p>生产环境程序常驻运行，为了避免日志文件过大，需要有生命周期管理。通常采用日志切割配置，将日志按照规则进行切割，并按照生命周期策略清理历史文件。</p>
<p><code>logging</code>包中提供两种方式切割：按照时间和按照大小。</p>
<ul>
<li><p>按大小：<code>logging.handlers.RotatingFileHandler</code>类；</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler</span><br><span class="line"></span><br><span class="line"><span class="comment"># logging.basicConfig()</span></span><br><span class="line">logger = logging.getLogger(<span class="string">'test'</span>)</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line">formatter = logging.Formatter(<span class="string">'"%(asctime)s - %(filename)s[line:%(lineno)d] - %(levelname)s: %(message)s"'</span>)</span><br><span class="line"><span class="comment"># 定义一个RotatingFileHandler，最多备份5个日志文件，每个日志文件最大0.01M</span></span><br><span class="line">rotatingHandler = RotatingFileHandler(<span class="string">'test.log'</span>, maxBytes=<span class="number">0.01</span>*<span class="number">1024</span>*<span class="number">1024</span>, backupCount=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">rotatingHandler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(rotatingHandler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是测试案例</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"__name__"</span> == <span class="string">"__main__"</span>:</span><br><span class="line">  <span class="keyword">while</span>(<span class="keyword">True</span>):</span><br><span class="line">    logger.info(<span class="string">"info"</span>)</span><br><span class="line"><span class="comment"># 会有5个日志文件：test.log test.log.1 test.log.2 test.log.3 test.log.4 test.log.5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>按时间：<code>logging.handlers.TimedRotatingFileHandler</code>类；</p>
<p>其中参数：<code>TimedRotatingFileHandler(filename [,when [,interval [,backupCount]]])</code></p>
<ul>
<li><p><code>filename</code> 输出文件名前缀；</p>
</li>
<li><p><code>when</code> 时间单位，字典如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">“S”: Seconds </span><br><span class="line">“M”: Minutes</span><br><span class="line">“H”: Hours</span><br><span class="line">“D”: Days</span><br><span class="line">“W”: Week day (0=Monday)</span><br><span class="line">“midnight”: Roll over at midnight（半夜）</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>interval</code> 等待多少个单位<code>when</code>的时间后，<code>Logger</code>会自动重建文件。</p>
</li>
<li><p><code>backupCount</code> 是保留日志个数，默认的0是不会自动删除掉日志。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> TimedRotatingFileHandler</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'test'</span>)</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line">formatter = logging.Formatter(<span class="string">'"%(asctime)s - %(filename)s[line:%(lineno)d] - %(levelname)s: %(message)s"'</span>)</span><br><span class="line"><span class="comment"># 定义一个TimedRotatingFileHandler，最多备份5个日志文件，1分钟切割一次</span></span><br><span class="line">timedRotatingFileHandler = TimedRotatingFileHandler(<span class="string">'Test.log'</span>, <span class="string">"M"</span>, <span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">timedRotatingFileHandler.suffix = <span class="string">"%Y%m%d-%H%M.log"</span></span><br><span class="line">timedRotatingFileHandler.setFormatter(formatter)</span><br><span class="line">logger.addHandler(timedRotatingFileHandler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是测试案例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">True</span>):</span><br><span class="line">        logger.info(<span class="string">"info"</span>)</span><br><span class="line"><span class="comment"># 输出日志：Test.log.20220505-2309.log，文件名为：filename+suffix</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="1-3-4-handler类"><a href="#1-3-4-handler类" class="headerlink" title="1.3.4 handler类"></a>1.3.4 <code>handler</code>类</h4><p><code>logging</code>包提供大量的<code>handler</code>方法类，其中<code>StreamHandler</code>、<code>FileHandler</code>、<code>NullHandler</code>源码在<code>__init__.py</code>文件中。其他<code>handler</code>在<code>handlers.py</code>中。全部说明如下：</p>
<ul>
<li><code>StreamHandler</code> 实例发送消息到流（类似文件对象）。可以是sys.stderr、sys.stdout或者文件。</li>
<li><code>FileHandler</code> 实例将消息发送到硬盘文件。</li>
<li><code>BaseRotatingHandler</code> 是轮换日志文件的处理程序的基类。它并不应该直接实例化。而应该使用 <code>RotatingFileHandler</code> 或 <code>TimedRotatingFileHandler</code> 代替它。</li>
<li><code>RotatingFileHandler</code> 实例将消息发送到硬盘文件，支持最大日志文件大小和日志文件轮换。</li>
<li><code>TimedRotatingFileHandler</code> 实例将消息发送到硬盘文件，以特定的时间间隔轮换日志文件。</li>
<li><code>SocketHandler</code> 实例将消息发送到 <code>TCP/IP</code> 套接字。从 3.4 开始，也支持 Unix 域套接字。</li>
<li><code>DatagramHandler</code> 实例将消息发送到 <code>UDP</code> 套接字。从 3.4 开始，也支持 Unix 域套接字。</li>
<li><code>SMTPHandler</code> 实例将消息发送到指定的电子邮件地址。</li>
<li><code>SysLogHandler</code> 实例将消息发送到 <code>Unix syslog</code> 守护程序，可能在远程计算机上。</li>
<li><code>NTEventLogHandler</code> 实例将消息发送到 <code>Windows NT/2000/XP</code> 事件日志。</li>
<li><code>MemoryHandler</code> 实例将消息发送到内存中的缓冲区，只要满足特定条件，缓冲区就会刷新。</li>
<li><code>HTTPHandler</code> 实例使用 <code>GET</code> 或 <code>POST</code> 方法将消息发送到 <code>HTTP</code> 服务器。</li>
<li><code>WatchedFileHandler</code> 实例会监视他们要写入日志的文件。如果文件发生更改，则会关闭该文件并使用文件名重新打开。此处理程序仅在类 <code>Unix</code> 系统上有用； <code>Windows</code> 不支持依赖的基础机制。</li>
<li><code>QueueHandler</code> 实例将消息发送到队列，例如在 <code>queue</code> 或 <code>multiprocessing</code> 模块中实现的队列。</li>
<li><code>NullHandler</code> 实例对错误消息不执行任何操作。它们由想要使用日志记录的库开发人员使用，但是想要避免如果库用户没有配置日志记录，则显示 “无法找到记录器<code>XXX</code>的消息处理器” 消息的情况。有关更多信息，请参阅 配置库的日志记录 。</li>
</ul>
<p>另外用户也可以自己实现<code>logging.Handler</code>方法，定义自己的<code>Handler</code>方法。然后在配置中引用使用即可。</p>
<h4 id="1-3-5-日志开关"><a href="#1-3-5-日志开关" class="headerlink" title="1.3.5 日志开关"></a>1.3.5 日志开关</h4><p>在特殊场景下，如果不需要输出日志。logging也提供响应的参数开关。例如对于定义的logger可以进行关闭，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logger = logging.getLogger(<span class="string">"FileLogger"</span>)</span><br><span class="line">logger.disabled = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>这样就关闭了。如果是配置文件中，可以将<code>handlers</code>的<code>list</code>置为空，即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FileLogger:</span><br><span class="line">   handlers: []</span><br><span class="line">   level: DEBUG</span><br><span class="line">   propagate: no</span><br></pre></td></tr></table></figure>
<p>如果需要禁用某个级别以下所有日志输出，可以使用下面的参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logging.disable(logging.INFO)</span><br><span class="line"><span class="comment"># 禁用INFO级别以下的所有日志</span></span><br></pre></td></tr></table></figure>
<p>注：这个参数会限制所有的<code>logger</code>的日志输出级别。</p>
<h4 id="1-3-5-日志过滤器"><a href="#1-3-5-日志过滤器" class="headerlink" title="1.3.5 日志过滤器"></a>1.3.5 日志过滤器</h4><p>业务代码产生的日志通常并不是都要作为日志输出的。所以在打印日志的时候我们对每条日志紧要程度进行了量化划分等级，即<code>INFO</code>、<code>DEBUG</code> 等。但是一些特殊的需求，这种粗粒度的等级划分并不能满足需求。能否提供可编程自定义的过滤函数<code>filter(record)</code>？</p>
<p><code>logging</code>并没有像<code>Handler</code>一样，为用户提供丰富的<code>filter</code>工具类。建议项目组可以像<code>java</code>中日志框架 <code>logback</code>一样提供部分常用的<code>filter</code>工具类。</p>
<p>logging没有现成可用的<code>filter</code>工具，就需要用户自己继承实现（<code>logging.Filter</code>）。例如下面的案例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoStringFilter</span><span class="params">(logging.Filter)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(self, record)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> record.getMessage().startswith(<span class="string">'user'</span>)</span><br><span class="line"></span><br><span class="line">logger.addFilter(NoStringFilter())</span><br></pre></td></tr></table></figure>
<p>定义 <code>filter</code> 方法，日志记录 record 作为唯一参数，返回值为 <code>0</code> 或 <code>False</code> 表示日志记录将被抛弃，<code>1</code> 或 <code>True</code>则表示记录别放过。</p>
<p>上面的案例实现了过滤<code>message</code>中以<code>user</code>开头的日志消息。对于<code>yaml</code>文件配置方式，我们在后文介绍。</p>
<p>另外从<code>Python3.2</code>起，用户自定义<code>filter</code>也可以不继承<code>logging.Filter</code>，只需要定义一个实现函数，<code>logger.addFilter</code>方法引入即可。例如我们在打印日志的时候，需要对于日志中一些敏感信息进行脱敏处理，例如密码信息。</p>
<p>下面的代码片段放在<code>__ini__.py</code>中，<code>Python</code>的模块名为：<code>logTest</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomFilter</span><span class="params">(logging.Filter)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(self, record)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> record.msg:</span><br><span class="line">            record.msg = record.msg.replace(<span class="string">"password"</span>, <span class="string">"*****"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'pwd'</span> <span class="keyword">in</span> record.msg:</span><br><span class="line">            record.msg = record.msg.replace(<span class="string">"pwd"</span>, <span class="string">"*****"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>对于<code>msg</code>中的字符串进行关键字替换脱密，对于含有<code>password</code>和<code>pwd</code>的字段。</p>
<p>在<code>yaml</code>配置文件中配置如下，在<code>handlers</code>中<code>console</code>应用该过滤器。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span></span><br><span class="line"><span class="attr">    filter_pwd:</span></span><br><span class="line">      <span class="string">():</span> <span class="string">logTest.CustomFilter</span></span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">  console:</span></span><br><span class="line"><span class="attr">     class:</span> <span class="string">logging.StreamHandler</span></span><br><span class="line"><span class="attr">     level:</span> <span class="string">INFO</span></span><br><span class="line"><span class="attr">     formatter:</span> <span class="string">custom</span></span><br><span class="line"><span class="attr">     filters:</span> <span class="string">[filter_pwd]</span></span><br></pre></td></tr></table></figure>
<p>这样对于日志中还有相关关键字的日志将被过滤。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logger.error(<span class="string">"user：admin and password"</span>)</span><br><span class="line"><span class="comment"># user：admin and *****</span></span><br></pre></td></tr></table></figure>
<h3 id="1-4-最佳实践"><a href="#1-4-最佳实践" class="headerlink" title="1.4  最佳实践"></a>1.4  最佳实践</h3><h4 id="1-4-1-yaml配置文件"><a href="#1-4-1-yaml配置文件" class="headerlink" title="1.4.1 yaml配置文件"></a>1.4.1 <code>yaml</code>配置文件</h4><p>对于生产环境<code>Python</code>项目运行，最佳实践当然是日志相关参数需要配置化，而不是耦合在业务代码中。所以首先是日志配置参数配置文件化。通常有几种方式：<code>ini</code>格式、<code>yaml</code>格式、<code>JSON</code> 格式、<code>Python</code>文件等，建议使用<code>yaml</code>格式。</p>
<p>例如下面的配置文件（<code>logConfig.yaml</code>）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">disable_existing_loggers:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">incremental:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="attr">formatters:</span></span><br><span class="line"><span class="attr">  standard:</span></span><br><span class="line"><span class="attr">      format:</span> <span class="string">"%(asctime)s - %(levelname)s - %(name)s(%(lineno)d) - %(message)s"</span></span><br><span class="line"><span class="attr">  error:</span></span><br><span class="line"><span class="attr">    format:</span> <span class="string">"%(asctime)s-%(levelname)s &lt;PID %(process)d:%(processName)s&gt; %(name)s.%(funcName)s(): %(message)s"</span></span><br><span class="line"><span class="attr">  custom:</span></span><br><span class="line"><span class="attr">    format:</span> <span class="string">"%(asctime)s - %(hostname)s - %(hostip)s - %(levelname)s - %(name)s(%(lineno)d) - %(message)s"</span></span><br><span class="line">    <span class="string">():</span> <span class="string">logTest.CustomFormatter</span></span><br><span class="line"></span><br><span class="line"><span class="attr">filters:</span></span><br><span class="line"><span class="attr">    require_debug_false:</span></span><br><span class="line">      <span class="string">():</span> <span class="string">logTest.NoParsingFilter</span></span><br><span class="line"><span class="attr">    filter_pwd:</span></span><br><span class="line">      <span class="string">():</span> <span class="string">logTest.CustomFilter</span></span><br><span class="line"></span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">  console:</span></span><br><span class="line"><span class="attr">     class:</span> <span class="string">logging.StreamHandler</span></span><br><span class="line"><span class="attr">     level:</span> <span class="string">INFO</span></span><br><span class="line"><span class="attr">     formatter:</span> <span class="string">custom</span></span><br><span class="line"><span class="attr">     filters:</span> <span class="string">[filter_pwd]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  file:</span></span><br><span class="line"><span class="attr">     class:</span> <span class="string">logging.FileHandler</span></span><br><span class="line"><span class="attr">     filename:</span> <span class="string">./logs/logging.log</span></span><br><span class="line"><span class="attr">     level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">     formatter:</span> <span class="string">standard</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  TimedRotatingfile:</span></span><br><span class="line"><span class="attr">      class:</span> <span class="string">logging.handlers.TimedRotatingFileHandler</span></span><br><span class="line"><span class="attr">      level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">      formatter:</span> <span class="string">standard</span></span><br><span class="line"><span class="attr">      filters:</span> <span class="string">[require_debug_false]</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">M</span></span><br><span class="line"><span class="attr">      backupCount:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">./logs/timedRotating.log</span></span><br><span class="line"><span class="attr">      encoding:</span> <span class="string">utf8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  rotatingFileHandler:</span></span><br><span class="line"><span class="attr">      class:</span> <span class="string">logging.handlers.RotatingFileHandler</span></span><br><span class="line"><span class="attr">      level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">      formatter:</span> <span class="string">standard</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">./logs/RotatingFile.log</span></span><br><span class="line"><span class="attr">      maxBytes:</span> <span class="number">100000</span></span><br><span class="line"><span class="attr">      backupCount:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      encoding:</span> <span class="string">utf8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">loggers:</span></span><br><span class="line"><span class="attr">  FileLogger:</span></span><br><span class="line"><span class="attr">     handlers:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">     level:</span> <span class="string">DEBUG</span></span><br><span class="line">     <span class="comment">#propagate: no</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  SampleLogger:</span></span><br><span class="line"><span class="attr">    level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">    handlers:</span> <span class="string">[console,rotatingFileHandler]</span></span><br><span class="line">    <span class="comment">#propagate: no</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  TestLogger:</span></span><br><span class="line"><span class="attr">    level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">    handlers:</span> <span class="string">[console]</span></span><br><span class="line">    <span class="comment">#propagate: no</span></span><br><span class="line"></span><br><span class="line"><span class="attr">root:</span></span><br><span class="line"><span class="attr">  level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">  handlers:</span> <span class="string">[]</span></span><br></pre></td></tr></table></figure>
<p>配置文件中参数说明如下：</p>
<ul>
<li><p><code>version</code>，版本参数，目前限定为1（或者1.0）；</p>
</li>
<li><p><code>disable_existing_loggers</code> ,参数值默认为True。</p>
<p>关于这个参数需要重点讲解一下，因为网上各类文章解释均有出入，笔者做了实验并查看了代码，解释如下。首先从字面意思来看，是否禁止已经存在的<code>loggers</code>。那么怎么理解已经存在的<code>loggers</code>？有下面的例子，我们有两个配置文件中分别定义了日志配置（<code>Config.yaml</code>和<code>logConfig.yaml</code>）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'Config.yaml'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = yaml.safe_load(f.read())</span><br><span class="line">    logging.config.dictConfig(config)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'logConfig.yaml'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = yaml.safe_load(f.read())</span><br><span class="line">    logging.config.dictConfig(config)</span><br></pre></td></tr></table></figure>
<p>两个配置文件中均定义了名称为<code>TestLogger</code>的<code>loggers</code>（但是配置定义不同，例如<code>Handler</code>参数不同）。但是配置文件<code>Config.yaml</code>和<code>logConfig.yaml</code>有加载先后顺序，那么哪个<code>loggers</code>是有效的呢？</p>
<p>这时候配置文件<code>logConfig.yaml</code>中<code>disable_existing_loggers</code>参数值为<code>True</code>，那么旧的配置失效，否则新的配置失效。</p>
</li>
<li><p><code>incremental</code>，中文是增加的意思。是否将此配置文件解释为现有配置的增量, 默认为<code>False</code>。该参数<code>True</code>是有不明错误，暂未研究参数用途。</p>
</li>
<li><p><code>formatters</code> ，日志格式化器。可以定义多个日志格式类型，供<code>handler</code>配置使用。</p>
</li>
<li><p><code>filters</code>，日志过滤器。配置</p>
</li>
<li><p><code>handlers</code>，日志处理器。例如配置文件中我们定义了：<code>console</code>、<code>file</code>、<code>TimedRotatingfile</code>、<code>RotatingFileHandler</code>。供后续<code>loggers</code>配置使用。举个例子，其他<code>handler</code>不在展开讲了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># handler名称标签</span></span><br><span class="line"><span class="attr">TimedRotatingfile:</span></span><br><span class="line">    <span class="comment"># handler实现类，也可以配置用户自己实现的Handler方法</span></span><br><span class="line"><span class="attr">    class:</span> <span class="string">logging.handlers.TimedRotatingFileHandler</span></span><br><span class="line">    <span class="comment"># 日志过滤级别</span></span><br><span class="line"><span class="attr">    level:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="comment"># 日志格式化方式而error，配置文件中配置使用</span></span><br><span class="line"><span class="attr">    formatter:</span> <span class="string">error</span></span><br><span class="line">    <span class="comment"># 过滤器选择，配置文件中需要已配置</span></span><br><span class="line"><span class="attr">    filters:</span> <span class="string">[require_debug_false]</span></span><br><span class="line">    <span class="comment"># 日志切割时间，M为分钟切割</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">M</span></span><br><span class="line">    <span class="comment"># 日志切割保存的文件数量</span></span><br><span class="line"><span class="attr">    backupCount:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment"># 日志文件名称，注意这里的绝对路径</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">./logs/timedRotating.log</span></span><br><span class="line">    <span class="comment"># 日志输出编码，utf8支持中文</span></span><br><span class="line"><span class="attr">    encoding:</span> <span class="string">utf8</span></span><br><span class="line">    <span class="comment"># 注意配置文件方式不支持自定义suffix值，目前只支持在代码中basicConfig配置</span></span><br><span class="line">    <span class="comment"># suffix: "%Y-%m-%d_%H-%M"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>loggers</code>，日志对象。配置文件中可以定义多个<code>loggers</code>。程序中使用下面方式调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger = logging.getLogger(<span class="string">"FileLogger"</span>)</span><br></pre></td></tr></table></figure>
<p>另外<code>logger</code>有一个重要的概念：父子<code>logger</code>。每个用户自定义的<code>logger</code>默认都是<code>root</code>的子<code>logger</code>，这时候，子<code>logger</code>的日志会发送给父级的<code>Logger</code>。当其中的参数<code>propagate</code>为<code>no</code>时候，则不再发送给父。例如下面的配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">FileLogger:</span></span><br><span class="line"><span class="attr">   handlers:</span> <span class="string">[TimedRotatingfile]</span></span><br><span class="line"><span class="attr">   level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">   propagate:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure>
<p>另外除了默认的<code>root</code>作为父<code>logger</code>，用户也可以自己定义，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger = logging.getLogger(<span class="string">"FileLogger.SampleLogger"</span>)</span><br></pre></td></tr></table></figure>
<p>这时候<code>FileLogger.SampleLogger</code>的父<code>logger</code>为<code>FileLogger</code>，并且默认<code>FileLogger</code>的父<code>logger</code>是<code>root</code>（如果有配置和定义）。即关系为：<code>FileLogger.SampleLogger----&gt;FileLogger---&gt;root</code>。</p>
<blockquote>
<p>那么对于<code>FileLogger.SampleLogger.TestLogger</code>，是否有多重父子传递呢？经过测试验证是不支持的，也就是说最多就2层。</p>
</blockquote>
</li>
<li><p><code>root</code>，终极父<code>logger</code>，接受所有子<code>logger</code>的日志发送，属于兜底处理。例如下面的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">root:</span></span><br><span class="line"><span class="attr">  level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">  handlers:</span> <span class="string">[]</span></span><br><span class="line">  <span class="comment"># handlers: [console]</span></span><br></pre></td></tr></table></figure>
<p><code>root</code>属于可选配置项。另外<code>handlers</code>配置为空，并且所有的子<code>logger</code>的<code>handlers</code>配置也为空，这时候会有默认输出，输出格式较为简单只有<code>%(message)s</code>信息。</p>
<p>如果一个日志对象没有指定具体的<code>logger</code>，那么就是<code>root</code>，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(logging.getLogger() == logging.root)</span><br><span class="line"><span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p>查看一下<code>root</code>的配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">print(logging.root.handlers)</span><br><span class="line">print(logging.lastResort)</span><br><span class="line">print(logging.root.filters)</span><br><span class="line"><span class="comment"># []</span></span><br><span class="line"><span class="comment"># &lt;_StderrHandler &lt;stderr&gt; (WARNING)&gt;</span></span><br><span class="line"><span class="comment"># []</span></span><br></pre></td></tr></table></figure>
<p>所以root默认的Handler是StderrHandler，并且日志级别是warning，输出到stderr（默认显示的字体是红色）。如果是shell脚本运行可以配置日志重定向：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python log.py 2&gt; /dev/null</span></span><br></pre></td></tr></table></figure>
<p>业务代码中如下加载配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'logConfig.yaml'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = yaml.safe_load(f.read())</span><br><span class="line">    logging.config.dictConfig(config)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">"FileLogger"</span>)</span><br><span class="line">logger1 = logging.getLogger(<span class="string">"SampleLogger"</span>)</span><br><span class="line"></span><br><span class="line">logger.debug(<span class="string">"debug"</span>)</span><br><span class="line">logger1.debug(<span class="string">"debug"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="1-4-2-其他配置文件"><a href="#1-4-2-其他配置文件" class="headerlink" title="1.4.2 其他配置文件"></a>1.4.2 其他配置文件</h4><p>对于<code>yaml</code>文件读取，使用了<code>yaml</code>包方式先将配置文件解释成字典对象，然后再通过下面的方法解析配置信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.config.dictConfig()</span><br></pre></td></tr></table></figure>
<p>其实<code>logging</code>提供原生接口直接读取配置文件的解析方法（如下）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.config.fileConfig()</span><br></pre></td></tr></table></figure>
<p>方式该方法目前只支持<code>configparser</code>类型的文件，即下面的<code>ini</code>格式的配置文件（截取片段）：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[loggers]</span></span><br><span class="line"><span class="attr">keys</span>=root,sampleLogger</span><br><span class="line"></span><br><span class="line"><span class="section">[handlers]</span></span><br><span class="line"><span class="attr">keys</span>=consoleHandler</span><br></pre></td></tr></table></figure>
<p><code>fileConfig()</code>是一个较老的接口，不支持配置Filter。官方建议后续尽量使用<code>dictConfig()</code>接口，后续新功能都将增加到<code>dictConfig()</code>接口。</p>
<p>对于<code>json</code>文件，<code>logConfig.json</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="attr">"disable_existing_loggers"</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"formatters"</span>:&#123;</span><br><span class="line">        <span class="attr">"simple"</span>:&#123;</span><br><span class="line">            <span class="attr">"format"</span>:<span class="string">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"handlers"</span>:&#123;</span><br><span class="line">        <span class="attr">"console"</span>:&#123;</span><br><span class="line">            <span class="attr">"class"</span>:<span class="string">"logging.StreamHandler"</span>,</span><br><span class="line">            <span class="attr">"level"</span>:<span class="string">"DEBUG"</span>,</span><br><span class="line">            <span class="attr">"formatter"</span>:<span class="string">"simple"</span>,</span><br><span class="line">            <span class="attr">"stream"</span>:<span class="string">"ext://sys.stdout"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"loggers"</span>:&#123;</span><br><span class="line">        <span class="attr">"my_module"</span>:&#123;</span><br><span class="line">            <span class="attr">"level"</span>:<span class="string">"ERROR"</span>,</span><br><span class="line">            <span class="attr">"handlers"</span>:[<span class="string">"console"</span>],</span><br><span class="line">            <span class="attr">"propagate"</span>:<span class="string">"no"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"root"</span>:&#123;</span><br><span class="line">        <span class="attr">"level"</span>:<span class="string">"INFO"</span>,</span><br><span class="line">        <span class="attr">"handlers"</span>:[<span class="string">"console"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件解析代码案例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'logConfig.json'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = json.load(f)</span><br><span class="line">    logging.config.dictConfig(config)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">"FileLogger"</span>)</span><br><span class="line">logger.debug(<span class="string">"debug"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="1-5-线程安全和进程不安全"><a href="#1-5-线程安全和进程不安全" class="headerlink" title="1.5 线程安全和进程不安全"></a>1.5 线程安全和进程不安全</h3><h4 id="1-5-1-线程安全"><a href="#1-5-1-线程安全" class="headerlink" title="1.5.1 线程安全"></a>1.5.1 线程安全</h4><p><code>logging</code> 库是线程安全的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span><span class="params">(Filterer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=NOTSET)</span>:</span></span><br><span class="line">        <span class="comment"># ......</span></span><br><span class="line">        self.createLock()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createLock</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Acquire a thread lock for serializing access to the underlying I/O.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.lock = threading.RLock()</span><br><span class="line">        _register_at_fork_reinit_lock(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Acquire the I/O thread lock.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.lock:</span><br><span class="line">            self.lock.acquire()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Release the I/O thread lock.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.lock:</span><br><span class="line">            self.lock.release()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, record)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Conditionally emit the specified logging record.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Emission depends on filters which may have been added to the handler.</span></span><br><span class="line"><span class="string">        Wrap the actual emission of the record with acquisition/release of</span></span><br><span class="line"><span class="string">        the I/O thread lock. Returns whether the filter passed the record for</span></span><br><span class="line"><span class="string">        emission.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        rv = self.filter(record)</span><br><span class="line">        <span class="keyword">if</span> rv:</span><br><span class="line">            self.acquire()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.emit(record)</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self.release()</span><br><span class="line">        <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>
<h4 id="1-5-2-进程安全"><a href="#1-5-2-进程安全" class="headerlink" title="1.5.2 进程安全"></a>1.5.2 进程安全</h4><h3 id="1-6-总结"><a href="#1-6-总结" class="headerlink" title="1.6 总结"></a>1.6 总结</h3><h2 id="参考文献及资料"><a href="#参考文献及资料" class="headerlink" title="参考文献及资料"></a>参考文献及资料</h2><p>1、<code>Logging</code>包，链接：<a href="https://docs.python.org/3.9/library/logging.html" target="_blank" rel="noopener">https://docs.python.org/3.9/library/logging.html</a></p>
<p>2、日志介绍，链接：<a href="https://rmcomplexity.com/article/2020/12/01/introduction-to-python-logging.html" target="_blank" rel="noopener">https://rmcomplexity.com/article/2020/12/01/introduction-to-python-logging.html</a></p>
<p>3、日志介绍，链接：<a href="https://coralogix.com/blog/python-logging-best-practices-tips/" target="_blank" rel="noopener">https://coralogix.com/blog/python-logging-best-practices-tips/</a></p>

      
    </div>

    

    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">
  <p><span>本文标题:</span><a href="/2022/05/05/2022-05-05-Python中日志框架（Logging库）/">Python中日志框架（Logging库）</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 rong xiang 的个人博客">rong xiang</a></p>
  <p><span>发布时间:</span>2022年05月05日 - 13:05</p>
  <p><span>最后更新:</span>2022年06月15日 - 13:06</p>
  <p><span>原始链接:</span><a href="/2022/05/05/2022-05-05-Python中日志框架（Logging库）/" title="Python中日志框架（Logging库）">https://zjrongxiang.github.io/2022/05/05/2022-05-05-Python中日志框架（Logging库）/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://zjrongxiang.github.io/2022/05/05/2022-05-05-Python中日志框架（Logging库）/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({   
          title: "",   
          text: '复制成功',   
          html: false,
          timer: 500,   
          showConfirmButton: false
        });
      });
    }));  
</script>

      
    </div>
    
    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/05/05/2022-05-11-impala使用总结/" rel="next" title="impala使用总结">
                <i class="fa fa-chevron-left"></i> impala使用总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/05/13/2022-05-13-logstash、Flume、filebeat文件解析如何实现exactly once语义/" rel="prev" title="logstash、Flume、filebeat文件解析如何实现exactly once语义">
                logstash、Flume、filebeat文件解析如何实现exactly once语义 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar/person.png" alt="rong xiang">
            
              <p class="site-author-name" itemprop="name">rong xiang</p>
              <p class="site-description motion-element" itemprop="description">Keep a Pure Curiosity</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">279</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">77</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/zjrongxiang" title="GitHub &rarr; https://github.com/zjrongxiang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:rongxiang1986@163.com" title="E-Mail &rarr; mailto:rongxiang1986@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="http://weibo.com/u/1971060643" title="Weibo &rarr; http://weibo.com/u/1971060643" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Link
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://weibo.com/fly51fly?refer_flag=1005055010_" title="https://weibo.com/fly51fly?refer_flag=1005055010_" rel="noopener" target="_blank">爱生活爱可可</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第一部分-内置Logging包"><span class="nav-number">2.</span> <span class="nav-text">第一部分 内置Logging包</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-日志级别"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 日志级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-日志流"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 日志流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-基本使用"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-例子"><span class="nav-number">2.3.1.</span> <span class="nav-text">1.3.1 例子</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-2-日志记录"><span class="nav-number">2.3.2.</span> <span class="nav-text">1.3.2 日志记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-3-日志切割"><span class="nav-number">2.3.3.</span> <span class="nav-text">1.3.3 日志切割</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-4-handler类"><span class="nav-number">2.3.4.</span> <span class="nav-text">1.3.4 handler类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-5-日志开关"><span class="nav-number">2.3.5.</span> <span class="nav-text">1.3.5 日志开关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-5-日志过滤器"><span class="nav-number">2.3.6.</span> <span class="nav-text">1.3.5 日志过滤器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-最佳实践"><span class="nav-number">2.4.</span> <span class="nav-text">1.4  最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-yaml配置文件"><span class="nav-number">2.4.1.</span> <span class="nav-text">1.4.1 yaml配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-2-其他配置文件"><span class="nav-number">2.4.2.</span> <span class="nav-text">1.4.2 其他配置文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-线程安全和进程不安全"><span class="nav-number">2.5.</span> <span class="nav-text">1.5 线程安全和进程不安全</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-1-线程安全"><span class="nav-number">2.5.1.</span> <span class="nav-text">1.5.1 线程安全</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-2-进程安全"><span class="nav-number">2.5.2.</span> <span class="nav-text">1.5.2 进程安全</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-总结"><span class="nav-number">2.6.</span> <span class="nav-text">1.6 总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文献及资料"><span class="nav-number">3.</span> <span class="nav-text">参考文献及资料</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rong xiang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">878k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">13:19</span>
  
</div>






        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  
    
  <script id="dsq-count-scr" src="https://https-zjrongxiang-github-io.disqus.com/count.js" async></script>


<script>
  var disqus_config = function () {
    this.page.url = "https://zjrongxiang.github.io/2022/05/05/2022-05-05-Python中日志框架（Logging库）/";
    this.page.identifier = "2022/05/05/2022-05-05-Python中日志框架（Logging库）/";
    this.page.title = 'Python中日志框架（Logging库）';
    };
  function loadComments () {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-zjrongxiang-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>

  





  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  
  

  


  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  
  

  
  

  


</body>
</html>
